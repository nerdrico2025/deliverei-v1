# üî¥ RELAT√ìRIO DE VAZAMENTOS DE DADOS MULTI-TENANT

**Data:** 2025-10-14
**Branch:** refactor/code-cleanup
**Severidade:** CR√çTICA

---

## üéØ Sum√°rio Executivo

Identificados **7 vazamentos cr√≠ticos** de dados multi-tenant que permitem acesso n√£o autorizado a dados de outras empresas.

---

## üî¥ Problemas Cr√≠ticos Identificados

### 1. **dashboard.service.ts** - 2 vazamentos

**Localiza√ß√£o:** `backend/src/dashboard/dashboard.service.ts`

#### Problema 1.1 - getEstatisticas (linhas 100-103)
```typescript
const produto = await this.prisma.produto.findUnique({
  where: { id: item.produtoId },
  select: { id: true, nome: true, imagem: true, preco: true },
});
```
**Impacto:** Busca produtos sem filtrar por empresaId. Pode retornar produtos de outras empresas.

**Solu√ß√£o:**
```typescript
const produto = await this.prisma.produto.findFirst({
  where: { id: item.produtoId, empresaId },
  select: { id: true, nome: true, imagem: true, preco: true },
});
```

#### Problema 1.2 - getProdutosPopulares (linhas 220-230)
```typescript
const produto = await this.prisma.produto.findUnique({
  where: { id: item.produtoId },
  select: { id: true, nome: true, imagem: true, preco: true, categoria: true },
});
```
**Impacto:** Mesmo problema - busca produtos sem filtrar por empresaId.

**Solu√ß√£o:**
```typescript
const produto = await this.prisma.produto.findFirst({
  where: { id: item.produtoId, empresaId },
  select: { id: true, nome: true, imagem: true, preco: true, categoria: true },
});
```

---

### 2. **avaliacoes.service.ts** - 4 vazamentos

**Localiza√ß√£o:** `backend/src/avaliacoes/avaliacoes.service.ts`

#### Problema 2.1 - create (linhas 12-14)
```typescript
const produto = await this.prisma.produto.findUnique({
  where: { id: createAvaliacaoDto.produtoId },
});
```
**Impacto:** Permite criar avalia√ß√µes para produtos de outras empresas.

**Solu√ß√£o:** Adicionar empresaId ao controller e passar para o service:
```typescript
// Controller
@Post()
create(@Body() createAvaliacaoDto: CreateAvaliacaoDto, @Request() req) {
  return this.avaliacoesService.create(createAvaliacaoDto, req.user.sub, req.user.empresaId);
}

// Service
async create(createAvaliacaoDto: CreateAvaliacaoDto, usuarioId: string, empresaId: string) {
  const produto = await this.prisma.produto.findFirst({
    where: { id: createAvaliacaoDto.produtoId, empresaId },
  });
  // ...
}
```

#### Problema 2.2 - findByProduto (linhas 43-68)
```typescript
async findByProduto(produtoId: string) {
  const avaliacoes = await this.prisma.avaliacao.findMany({
    where: { produtoId },
    // ...
  });
}
```
**Impacto:** N√£o valida se o produto pertence √† empresa do usu√°rio. Permite ver avalia√ß√µes de produtos de outras empresas.

**Solu√ß√£o:** Adicionar valida√ß√£o de empresaId:
```typescript
// Controller
@Get('produto/:produtoId')
findByProduto(@Param('produtoId') produtoId: string, @Request() req) {
  return this.avaliacoesService.findByProduto(produtoId, req.user.empresaId);
}

// Service
async findByProduto(produtoId: string, empresaId: string) {
  // Verificar se produto pertence √† empresa
  const produto = await this.prisma.produto.findFirst({
    where: { id: produtoId, empresaId },
  });
  
  if (!produto) {
    throw new NotFoundException('Produto n√£o encontrado');
  }
  
  const avaliacoes = await this.prisma.avaliacao.findMany({
    where: { produtoId },
    // ...
  });
  // ...
}
```

#### Problema 2.3 - findByUsuario (linhas 70-84)
```typescript
async findByUsuario(usuarioId: string) {
  return this.prisma.avaliacao.findMany({
    where: { usuarioId },
    // ...
  });
}
```
**Impacto:** Retorna todas as avalia√ß√µes do usu√°rio sem filtrar por empresa. Um usu√°rio pode ter avalia√ß√µes em m√∫ltiplas empresas e ver todas elas.

**Solu√ß√£o:**
```typescript
// Controller
@Get('usuario')
findByUsuario(@Request() req) {
  return this.avaliacoesService.findByUsuario(req.user.sub, req.user.empresaId);
}

// Service - Op√ß√£o 1: Filtrar por empresa
async findByUsuario(usuarioId: string, empresaId: string) {
  return this.prisma.avaliacao.findMany({
    where: { 
      usuarioId,
      produto: { empresaId }
    },
    include: {
      produto: {
        select: {
          id: true,
          nome: true,
          imagem: true,
        },
      },
    },
    orderBy: { createdAt: 'desc' },
  });
}

// Op√ß√£o 2: Retornar todas mas identificar a empresa
// Depende do requisito de neg√≥cio
```

#### Problema 2.4 - remove (linhas 86-102)
```typescript
async remove(id: string, usuarioId: string) {
  const avaliacao = await this.prisma.avaliacao.findUnique({
    where: { id },
  });
  // ...
}
```
**Impacto:** N√£o valida se a avalia√ß√£o pertence a um produto da empresa do usu√°rio.

**Solu√ß√£o:**
```typescript
// Controller
@Delete(':id')
remove(@Param('id') id: string, @Request() req) {
  return this.avaliacoesService.remove(id, req.user.sub, req.user.empresaId);
}

// Service
async remove(id: string, usuarioId: string, empresaId: string) {
  const avaliacao = await this.prisma.avaliacao.findUnique({
    where: { id },
    include: { produto: true },
  });

  if (!avaliacao) {
    throw new NotFoundException('Avalia√ß√£o n√£o encontrada');
  }

  if (avaliacao.usuarioId !== usuarioId) {
    throw new ForbiddenException('Voc√™ n√£o pode deletar esta avalia√ß√£o');
  }

  // Validar se o produto pertence √† empresa
  if (avaliacao.produto.empresaId !== empresaId) {
    throw new ForbiddenException('Avalia√ß√£o n√£o encontrada');
  }

  return this.prisma.avaliacao.delete({
    where: { id },
  });
}
```

---

### 3. **pedidos.service.ts** - 1 vazamento CR√çTICO

**Localiza√ß√£o:** `backend/src/pedidos/pedidos.service.ts`

#### Problema 3.1 - findMeusPedidos (linhas 83-118)
```typescript
async findMeusPedidos(usuarioId: string, page: number = 1, limit: number = 10) {
  const [pedidos, total] = await Promise.all([
    this.prisma.pedido.findMany({
      where: { clienteId: usuarioId }, // ‚ùå SEM FILTRO DE EMPRESAID!
      // ...
    }),
    this.prisma.pedido.count({ where: { clienteId: usuarioId } }),
  ]);
  // ...
}
```

**Impacto:** **CR√çTICO!** Um cliente que fez pedidos em m√∫ltiplas empresas pode ver TODOS os seus pedidos, independente de qual empresa est√° acessando.

**Exemplo de Exploit:**
1. Cliente faz pedido na Pizza Express (empresa A)
2. Cliente faz pedido na Burger King (empresa B)
3. Cliente acessa app da Pizza Express
4. Cliente v√™ pedidos de ambas empresas (vazamento!)

**Solu√ß√£o:**
```typescript
// Controller j√° passa empresaId, mas service n√£o usa
@Get('meus')
findMeusPedidos(
  @Request() req,
  @Query('page') page: string = '1',
  @Query('limit') limit: string = '10',
) {
  return this.pedidosService.findMeusPedidos(
    req.user.sub,
    req.user.empresaId, // Adicionar empresaId
    parseInt(page, 10),
    parseInt(limit, 10),
  );
}

// Service
async findMeusPedidos(
  usuarioId: string,
  empresaId: string, // Adicionar par√¢metro
  page: number = 1,
  limit: number = 10
) {
  const skip = (page - 1) * limit;

  const [pedidos, total] = await Promise.all([
    this.prisma.pedido.findMany({
      where: { 
        clienteId: usuarioId,
        empresaId // Adicionar filtro
      },
      include: {
        itens: {
          include: {
            produto: {
              select: {
                id: true,
                nome: true,
                imagem: true,
              },
            },
          },
        },
      },
      orderBy: { createdAt: 'desc' },
      skip,
      take: limit,
    }),
    this.prisma.pedido.count({ 
      where: { 
        clienteId: usuarioId,
        empresaId // Adicionar filtro
      } 
    }),
  ]);

  return {
    pedidos,
    paginacao: {
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    },
  };
}
```

---

## üîß Poss√≠vel Causa do Erro 500 no Gr√°fico de Vendas

Analisando as imagens fornecidas, o erro "Erro ao carregar dados de vendas" no dashboard pode ser causado por:

1. **Dados inv√°lidos no banco:** Valores Decimal malformados
2. **Convers√£o de tipos:** Number(pedido.total) pode falhar se total for null
3. **Datas inv√°lidas:** Problemas com parsing de datas

**Recomenda√ß√£o:** Adicionar try-catch e valida√ß√£o:

```typescript
async getGraficoVendas(
  empresaId: string, 
  periodo: 'dia' | 'semana' | 'mes' = 'dia',
  startDate?: Date,
  endDate?: Date,
) {
  try {
    // c√≥digo existente...
    
    const vendas = pedidos.reduce((acc, pedido) => {
      try {
        let chave: string;
        const data = new Date(pedido.createdAt);

        if (groupBy === 'day') {
          chave = data.toISOString().split('T')[0];
        } else if (groupBy === 'week') {
          const inicioSemana = new Date(data);
          inicioSemana.setDate(data.getDate() - data.getDay());
          chave = inicioSemana.toISOString().split('T')[0];
        } else {
          chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
        }

        if (!acc[chave]) {
          acc[chave] = 0;
        }
        
        const total = Number(pedido.total);
        if (!isNaN(total) && isFinite(total)) {
          acc[chave] += total;
        }

        return acc;
      } catch (itemError) {
        console.error('Erro processando pedido:', pedido.id, itemError);
        return acc;
      }
    }, {});

    return Object.entries(vendas).map(([data, total]) => ({
      data,
      total: Number(total),
    }));
  } catch (error) {
    console.error('Erro em getGraficoVendas:', error);
    throw new InternalServerErrorException('Erro ao buscar dados de vendas');
  }
}
```

---

## üìã Plano de A√ß√£o

1. ‚úÖ Identificar todos os vazamentos (conclu√≠do)
2. ‚è≥ Corrigir dashboard.service.ts (2 corre√ß√µes)
3. ‚è≥ Corrigir avaliacoes.service.ts (4 corre√ß√µes)
4. ‚è≥ Corrigir pedidos.service.ts (1 corre√ß√£o CR√çTICA)
5. ‚è≥ Adicionar error handling no gr√°fico de vendas
6. ‚è≥ Testar todas as corre√ß√µes
7. ‚è≥ Commit at√¥mico das corre√ß√µes

---

## üß™ Testes Necess√°rios

Ap√≥s corre√ß√µes, validar:

1. ‚úÖ Dashboard carrega dados apenas da empresa correta
2. ‚úÖ Avalia√ß√µes s√≥ s√£o criadas em produtos da empresa
3. ‚úÖ Cliente v√™ apenas pedidos da empresa atual
4. ‚úÖ Gr√°fico de vendas n√£o retorna erro 500
5. ‚úÖ Produtos n√£o s√£o compartilhados entre empresas

---

## üìä Impacto Estimado

- **Seguran√ßa:** CR√çTICO - Vazamento de dados entre empresas
- **Performance:** Nenhum impacto negativo
- **Breaking Changes:** Nenhum (corre√ß√µes internas)
- **Riscos:** Baixo - Corre√ß√µes s√£o adi√ß√µes de filtros seguros
